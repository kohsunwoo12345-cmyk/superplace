<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¶œì„ & ìˆ™ì œ ì œì¶œ í…ŒìŠ¤íŠ¸</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
    h1, h2 { color: #333; }
    .step { 
      margin: 20px 0; 
      padding: 15px; 
      border: 2px solid #ddd; 
      border-radius: 8px;
      background: #f9f9f9;
    }
    .step.active { border-color: #4CAF50; background: #e8f5e9; }
    .step.done { border-color: #2196F3; background: #e3f2fd; }
    button { 
      padding: 12px 24px; 
      margin: 10px 5px 0 0;
      font-size: 16px; 
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #4CAF50;
      color: white;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    input { 
      padding: 10px; 
      margin: 10px 0;
      font-size: 16px;
      width: 200px;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    video { 
      width: 100%; 
      max-width: 600px; 
      border: 3px solid #333; 
      border-radius: 8px;
      background: #000;
    }
    .log { 
      background: #f0f0f0; 
      padding: 8px; 
      margin: 5px 0; 
      border-left: 4px solid #4CAF50;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .log.error { border-left-color: #f44336; color: #c62828; }
    .log.success { border-left-color: #4CAF50; color: #2e7d32; }
    .log.info { border-left-color: #2196F3; color: #1565c0; }
    #logs { max-height: 400px; overflow-y: auto; margin-top: 20px; }
    .image-preview { 
      max-width: 200px; 
      margin: 10px;
      border: 2px solid #4CAF50;
      border-radius: 5px;
    }
    .result { 
      padding: 15px; 
      margin: 10px 0;
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
    }
    #cameraStatus {
      padding: 10px;
      margin: 10px 0;
      font-weight: bold;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª ì¶œì„ & ìˆ™ì œ ì œì¶œ ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h1>
  
  <div id="step1" class="step active">
    <h2>1ë‹¨ê³„: ì¶œì„ ì½”ë“œ ì¸ì¦</h2>
    <input type="text" id="attendanceCode" placeholder="6ìë¦¬ ì½”ë“œ" maxlength="6" />
    <button onclick="verifyAttendance()">ì¶œì„ ì¸ì¦</button>
    <div id="attendanceResult"></div>
  </div>

  <div id="step2" class="step">
    <h2>2ë‹¨ê³„: ì¹´ë©”ë¼ í…ŒìŠ¤íŠ¸ (1ì´ˆ ë‚´ í™œì„±í™”)</h2>
    <button onclick="testCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
    <button onclick="stopCamera()">ì¹´ë©”ë¼ ì¤‘ì§€</button>
    <div id="cameraStatus"></div>
    <video id="video" autoplay playsinline muted style="display:none; margin-top: 10px;"></video>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <div id="step3" class="step">
    <h2>3ë‹¨ê³„: ì‚¬ì§„ ì´¬ì˜ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</h2>
    <button onclick="capturePhoto()" id="captureBtn" disabled>ì‚¬ì§„ ì´¬ì˜</button>
    <button onclick="clearPhotos()">ëª¨ë‘ ì‚­ì œ</button>
    <div id="photoCount" style="margin: 10px 0; font-weight: bold;"></div>
    <div id="photos"></div>
  </div>

  <div id="step4" class="step">
    <h2>4ë‹¨ê³„: ìˆ™ì œ ì œì¶œ & AI ì±„ì </h2>
    <button onclick="submitHomework()" id="submitBtn" disabled>ìˆ™ì œ ì œì¶œ ë° ì±„ì </button>
    <div id="gradingResult"></div>
  </div>

  <div id="logs"></div>

  <script>
    let stream = null;
    let capturedPhotos = [];
    let userId = null;
    let userName = null;
    let attendanceCode = null;
    let cameraReadyTime = 0;

    const BASE_URL = 'https://genspark-ai-developer.superplacestudy.pages.dev';

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      document.getElementById('logs').insertBefore(div, document.getElementById('logs').firstChild);
      console.log(message);
    }

    async function verifyAttendance() {
      const code = document.getElementById('attendanceCode').value.trim();
      if (!code || code.length !== 6) {
        alert('6ìë¦¬ ì¶œì„ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      log('ğŸ“¤ ì¶œì„ ì¸ì¦ ìš”ì²­...', 'info');
      
      try {
        const response = await fetch(`${BASE_URL}/api/attendance/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        const data = await response.json();
        log(`ì‘ë‹µ: ${JSON.stringify(data)}`, 'info');

        if (response.ok && data.success) {
          userId = data.student.id;
          userName = data.student.name;
          attendanceCode = code;
          
          log(`âœ… ì¶œì„ ì¸ì¦ ì„±ê³µ! í•™ìƒ: ${userName}`, 'success');
          document.getElementById('attendanceResult').innerHTML = 
            `<div class="result">âœ… ${userName}ë‹˜ ì¶œì„ ì™„ë£Œ (${data.attendance.status})</div>`;
          
          document.getElementById('step1').classList.remove('active');
          document.getElementById('step1').classList.add('done');
          document.getElementById('step2').classList.add('active');
        } else {
          log(`âŒ ì¶œì„ ì¸ì¦ ì‹¤íŒ¨: ${data.error || data.message}`, 'error');
          alert(data.message || data.error || 'ì¶œì„ ì¸ì¦ ì‹¤íŒ¨');
        }
      } catch (err) {
        log(`âŒ ì˜¤ë¥˜: ${err.message}`, 'error');
        alert('ì¶œì„ ì¸ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      }
    }

    async function testCamera() {
      log('ğŸ“¸ ì¹´ë©”ë¼ ì‹œì‘...', 'info');
      const startTime = Date.now();
      
      try {
        const statusDiv = document.getElementById('cameraStatus');
        statusDiv.textContent = 'â³ ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...';
        statusDiv.style.background = '#fff3cd';

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 }
        });
        
        log('âœ… ìŠ¤íŠ¸ë¦¼ íšë“ ì™„ë£Œ', 'success');

        const video = document.getElementById('video');
        video.srcObject = stream;
        video.style.display = 'block';
        
        await video.play();

        // ì¤€ë¹„ ìƒíƒœ ì²´í¬
        const checkReady = () => {
          if (video.videoWidth > 0) {
            cameraReadyTime = Date.now() - startTime;
            log(`âœ… ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ! (${cameraReadyTime}ms)`, 'success');
            
            statusDiv.textContent = `âœ… ì¹´ë©”ë¼ í™œì„±í™” ì™„ë£Œ (${cameraReadyTime}ms)`;
            statusDiv.style.background = '#d4edda';
            
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('done');
            document.getElementById('step3').classList.add('active');
            
            if (cameraReadyTime > 1000) {
              log(`âš ï¸ ê²½ê³ : 1ì´ˆ ì´ˆê³¼ (${cameraReadyTime}ms)`, 'error');
            }
            return true;
          }
          return false;
        };

        // ì¦‰ì‹œ ì²´í¬
        if (checkReady()) return;

        // 100msë§ˆë‹¤ ì²´í¬ (ìµœëŒ€ 20ë²ˆ = 2ì´ˆ)
        let attempts = 0;
        const interval = setInterval(() => {
          attempts++;
          if (checkReady() || attempts >= 20) {
            clearInterval(interval);
            if (attempts >= 20) {
              log('âš ï¸ 2ì´ˆ ê²½ê³¼, ê°•ì œ í™œì„±í™”', 'error');
              document.getElementById('captureBtn').disabled = false;
              statusDiv.textContent = 'âš ï¸ ì¹´ë©”ë¼ ì¤€ë¹„ ì§€ì—° (ê°•ì œ í™œì„±í™”)';
              statusDiv.style.background = '#f8d7da';
            }
          }
        }, 100);

      } catch (err) {
        log(`âŒ ì¹´ë©”ë¼ ì˜¤ë¥˜: ${err.name} - ${err.message}`, 'error');
        document.getElementById('cameraStatus').textContent = `âŒ ì˜¤ë¥˜: ${err.message}`;
        document.getElementById('cameraStatus').style.background = '#f8d7da';
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        document.getElementById('video').style.display = 'none';
        document.getElementById('cameraStatus').textContent = 'ì¹´ë©”ë¼ ì¤‘ì§€ë¨';
        log('ğŸ›‘ ì¹´ë©”ë¼ ì¤‘ì§€', 'info');
      }
    }

    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      const photo = canvas.toDataURL('image/jpeg', 0.8);
      capturedPhotos.push(photo);
      
      log(`ğŸ“· ì‚¬ì§„ ì´¬ì˜ ì™„ë£Œ (${capturedPhotos.length}ì¥)`, 'success');
      
      updatePhotoDisplay();
    }

    function updatePhotoDisplay() {
      const photosDiv = document.getElementById('photos');
      photosDiv.innerHTML = capturedPhotos.map((photo, i) => 
        `<img src="${photo}" class="image-preview" alt="ì‚¬ì§„ ${i+1}" />`
      ).join('');
      
      document.getElementById('photoCount').textContent = 
        `ì´¬ì˜í•œ ì‚¬ì§„: ${capturedPhotos.length}ì¥`;
      
      document.getElementById('submitBtn').disabled = capturedPhotos.length === 0;
      
      if (capturedPhotos.length > 0) {
        document.getElementById('step3').classList.remove('active');
        document.getElementById('step3').classList.add('done');
        document.getElementById('step4').classList.add('active');
      }
    }

    function clearPhotos() {
      capturedPhotos = [];
      updatePhotoDisplay();
      log('ğŸ—‘ï¸ ëª¨ë“  ì‚¬ì§„ ì‚­ì œ', 'info');
    }

    async function submitHomework() {
      if (!userId) {
        alert('ë¨¼ì € ì¶œì„ ì¸ì¦ì„ í•´ì£¼ì„¸ìš”');
        return;
      }

      if (capturedPhotos.length === 0) {
        alert('ìµœì†Œ 1ì¥ì˜ ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”');
        return;
      }

      log(`ğŸ“¤ ìˆ™ì œ ì œì¶œ ì‹œì‘ (${capturedPhotos.length}ì¥)...`, 'info');
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('submitBtn').textContent = 'ì±„ì  ì¤‘...';

      try {
        const response = await fetch(`${BASE_URL}/api/homework/grade`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            code: attendanceCode,
            images: capturedPhotos
          })
        });

        const data = await response.json();
        log(`ì±„ì  ì‘ë‹µ: ${JSON.stringify(data)}`, 'info');

        if (response.ok) {
          log(`âœ… ì±„ì  ì™„ë£Œ! ì ìˆ˜: ${data.grading.score}ì `, 'success');
          
          document.getElementById('gradingResult').innerHTML = `
            <div class="result">
              <h3>ğŸ“Š ì±„ì  ê²°ê³¼</h3>
              <p><strong>ì ìˆ˜:</strong> ${data.grading.score}ì  / 100ì </p>
              <p><strong>ì •ë‹µ ìˆ˜:</strong> ${data.grading.correctAnswers || 0} / ${data.grading.totalQuestions || 0}</p>
              <p><strong>í”¼ë“œë°±:</strong> ${data.grading.feedback}</p>
              <p><strong>ê°•ì :</strong> ${data.grading.strengths}</p>
              <p><strong>ê°œì„ ì‚¬í•­:</strong> ${data.grading.suggestions}</p>
              ${data.grading.weaknessTypes && data.grading.weaknessTypes.length > 0 ? 
                `<p><strong>ì•½ì  ìœ í˜•:</strong> ${data.grading.weaknessTypes.join(', ')}</p>` : ''}
            </div>
          `;

          document.getElementById('step4').classList.remove('active');
          document.getElementById('step4').classList.add('done');
          
          log('âœ… ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì™„ë£Œ!', 'success');
        } else {
          log(`âŒ ì±„ì  ì‹¤íŒ¨: ${data.error}`, 'error');
          alert('ì±„ì  ì‹¤íŒ¨: ' + data.error);
        }
      } catch (err) {
        log(`âŒ ì˜¤ë¥˜: ${err.message}`, 'error');
        alert('ìˆ™ì œ ì œì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
      } finally {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'ìˆ™ì œ ì œì¶œ ë° ì±„ì ';
      }
    }

    log('ğŸ“± í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
    log('â„¹ï¸ 1ë‹¨ê³„ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ì§„í–‰í•˜ì„¸ìš”', 'info');
  </script>
</body>
</html>
