// Prisma Schema for Academy Learning Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 학원 모델
model Academy {
  id              String    @id @default(cuid())
  name            String    // 학원 이름
  description     String?
  address         String?
  phone           String?
  email           String?
  logoUrl         String?
  subscriptionPlan String   @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  maxStudents     Int       @default(10)     // 요금제별 학생 수 제한
  maxTeachers     Int       @default(2)      // 요금제별 선생님 수 제한
  aiUsageLimit    Int       @default(100)    // 월별 AI 사용 횟수 제한
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  users           User[]
  subscriptions   Subscription[]
  aiUsages        AIUsage[]
  
  @@index([subscriptionPlan])
}

// 구독/요금제 이력
model Subscription {
  id              String    @id @default(cuid())
  academyId       String
  plan            String    // FREE, BASIC, PRO, ENTERPRISE
  status          String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  startDate       DateTime  @default(now())
  endDate         DateTime?
  price           Decimal   @default(0)
  paymentMethod   String?
  transactionId   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  
  @@index([academyId, status])
  @@index([endDate])
}

// AI 사용량 추적
model AIUsage {
  id              String    @id @default(cuid())
  academyId       String
  userId          String
  model           String    @default("gemini-pro") // gemini-pro, gemini-pro-vision
  promptTokens    Int       @default(0)
  completionTokens Int      @default(0)
  totalTokens     Int       @default(0)
  request         String    @db.Text // 요청 내용
  response        String?   @db.Text // 응답 내용
  createdAt       DateTime  @default(now())
  
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([academyId, createdAt])
  @@index([userId, createdAt])
}

// User Model - 시스템 관리자, 학원장, 선생님, 학생
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  phone         String?
  role          String    @default("STUDENT") // SUPER_ADMIN, DIRECTOR, TEACHER, STUDENT
  academyId     String?   // 소속 학원 (SUPER_ADMIN은 null)
  grade         String?   // 학년 (학생용)
  class         String?   // 반 (학생용)
  studentId     String?   @unique // 학번 (학생용)
  parentPhone   String?   // 학부모 연락처 (학생용)
  points        Int       @default(0) // 포인트
  aiEnabled     Boolean   @default(false) // AI 봇 사용 권한
  emailVerified DateTime?
  image         String?
  approved      Boolean   @default(false) // 학원장/관리자 승인 필요
  approvedBy    String?
  approvedAt    DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  academy       Academy?  @relation(fields: [academyId], references: [id], onDelete: SetNull)
  accounts      Account[]
  sessions      Session[]
  aiUsages      AIUsage[]
  pointHistory  PointHistory[]
  
  // 학생 관련 데이터
  learningProgress  LearningProgress[]
  assignments       Assignment[]
  testScores        TestScore[]
  attendances       Attendance[]
  
  // 선생님이 생성한 자료
  createdMaterials  LearningMaterial[] @relation("CreatedBy")
  createdAssignments Assignment[] @relation("AssignedBy")
  
  @@index([academyId])
  @@index([role])
  @@index([approved])
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 학습 자료 관리
model LearningMaterial {
  id            String      @id @default(cuid())
  academyId     String      // 소속 학원
  title         String
  description   String?
  subject       String      // 과목 (수학, 영어, 과학 등)
  grade         String      // 학년
  category      String      // 카테고리 (강의, 교재, 연습문제 등)
  contentType   String      // 콘텐츠 타입 (video, pdf, quiz, text)
  contentUrl    String?     // 파일/동영상 URL
  content       String?     @db.Text // 텍스트 콘텐츠
  duration      Int?        // 예상 학습 시간 (분)
  difficulty    String      @default("MEDIUM") // EASY, MEDIUM, HARD
  tags          String?     // JSON array
  viewCount     Int         @default(0)
  isPublished   Boolean     @default(true)
  order         Int         @default(0) // 순서
  createdById   String
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  progress      LearningProgress[]
  assignments   Assignment[]
  
  @@index([academyId])
  @@index([subject, grade])
  @@index([createdById])
}

// 학습 진도 관리
model LearningProgress {
  id              String          @id @default(cuid())
  userId          String
  materialId      String
  status          String          @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED
  progress        Int             @default(0) // 0-100%
  timeSpent       Int             @default(0) // 학습 시간 (분)
  lastAccessedAt  DateTime        @default(now())
  completedAt     DateTime?
  notes           String?         // 학생 메모
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  material        LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  
  @@unique([userId, materialId])
  @@index([userId, status])
}

// 과제 관리
model Assignment {
  id            String      @id @default(cuid())
  title         String
  description   String?
  materialId    String?     // 연결된 학습 자료
  userId        String      // 과제를 받은 학생
  assignedById  String      // 과제를 부여한 선생님/학원장
  subject       String
  dueDate       DateTime
  status        String      @default("PENDING") // PENDING, SUBMITTED, GRADED
  submittedAt   DateTime?
  submission    String?     // 제출 내용
  score         Int?        // 점수
  feedback      String?     // 피드백
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedBy    User        @relation("AssignedBy", fields: [assignedById], references: [id])
  material      LearningMaterial? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  
  @@index([userId, status])
  @@index([dueDate])
}

// 시험 점수 관리
model TestScore {
  id            String      @id @default(cuid())
  userId        String
  subject       String
  testName      String
  testDate      DateTime
  score         Int
  maxScore      Int         @default(100)
  grade         String?     // 등급
  rank          Int?        // 석차
  totalStudents Int?        // 응시 인원
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, testDate])
  @@index([subject])
}

// 출석 관리
model Attendance {
  id            String      @id @default(cuid())
  userId        String
  date          DateTime
  status        String      // PRESENT(출석), ABSENT(결석), LATE(지각), EXCUSED(조퇴)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([date])
  @@index([userId, status])
}

// 공지사항
model Notice {
  id            String      @id @default(cuid())
  academyId     String?     // null이면 전체 공지
  title         String
  content       String      @db.Text
  author        String
  category      String      @default("GENERAL") // GENERAL, IMPORTANT, EVENT
  isPinned      Boolean     @default(false)
  viewCount     Int         @default(0)
  publishedAt   DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([academyId])
  @@index([publishedAt])
  @@index([category, isPinned])
}

// 문의하기
model Contact {
  id            String      @id @default(cuid())
  name          String
  email         String
  phone         String?
  subject       String
  message       String      @db.Text
  status        String      @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED
  response      String?     @db.Text
  respondedBy   String?     // 응답한 관리자 ID
  respondedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

// 포인트 이력
model PointHistory {
  id            String      @id @default(cuid())
  userId        String
  amount        Int         // 양수: 지급, 음수: 회수
  balance       Int         // 거래 후 잔액
  type          String      // GRANT, DEDUCT, PURCHASE, REWARD
  reason        String?     // 사유
  adminId       String?     // 처리한 관리자 ID
  createdAt     DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
}
