// Prisma Schema for Academy Learning Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// í•™ì› ëª¨ë¸
model Academy {
  id              String    @id @default(cuid())
  name            String    // í•™ì› ì´ë¦„
  code            String    @unique // í•™ì› ì½”ë“œ (ê°€ì…ìš©)
  description     String?
  address         String?
  phone           String?
  email           String?
  logoUrl         String?
  naverPlaceUrl   String?   // ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ URL
  naverBlogUrl    String?   // ë„¤ì´ë²„ ë¸”ë¡œê·¸ URL
  subscriptionPlan String   @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  maxStudents     Int       @default(10)     // ìš”ê¸ˆì œë³„ í•™ìƒ ìˆ˜ ì œí•œ
  maxTeachers     Int       @default(2)      // ìš”ê¸ˆì œë³„ ì„ ìƒë‹˜ ìˆ˜ ì œí•œ
  aiUsageLimit    Int       @default(100)    // ì›”ë³„ AI ì‚¬ìš© íšŸìˆ˜ ì œí•œ
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  users           User[]
  subscriptions   Subscription[]
  aiUsages        AIUsage[]
  
  @@index([subscriptionPlan])
  @@index([code])
}

// êµ¬ë…/ìš”ê¸ˆì œ ì´ë ¥
model Subscription {
  id              String    @id @default(cuid())
  academyId       String
  plan            String    // FREE, BASIC, PRO, ENTERPRISE
  status          String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  startDate       DateTime  @default(now())
  endDate         DateTime?
  price           Decimal   @default(0)
  paymentMethod   String?
  transactionId   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  
  @@index([academyId, status])
  @@index([endDate])
}

// AI ì‚¬ìš©ëŸ‰ ì¶”ì 
model AIUsage {
  id              String    @id @default(cuid())
  academyId       String
  userId          String
  model           String    @default("gemini-pro") // gemini-pro, gemini-pro-vision
  promptTokens    Int       @default(0)
  completionTokens Int      @default(0)
  totalTokens     Int       @default(0)
  request         String    @db.Text // ìš”ì²­ ë‚´ìš©
  response        String?   @db.Text // ì‘ë‹µ ë‚´ìš©
  createdAt       DateTime  @default(now())
  
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([academyId, createdAt])
  @@index([userId, createdAt])
}

// User Model - ì‹œìŠ¤í…œ ê´€ë¦¬ì, í•™ì›ì¥, ì„ ìƒë‹˜, í•™ìƒ
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  phone         String?
  role          String    @default("STUDENT") // SUPER_ADMIN, DIRECTOR, TEACHER, STUDENT
  academyId     String?   // ì†Œì† í•™ì› (SUPER_ADMINì€ null)
  grade         String?   // í•™ë…„ (í•™ìƒìš©)
  class         String?   // ë°˜ (í•™ìƒìš©) - deprecated, StudentClass ì‚¬ìš©
  studentId     String?   @unique // í•™ë²ˆ (í•™ìƒìš©)
  parentPhone   String?   // í•™ë¶€ëª¨ ì—°ë½ì²˜ (í•™ìƒìš©)
  points        Int       @default(0) // í¬ì¸íŠ¸
  aiChatEnabled     Boolean @default(false) // AI ì±„íŒ… ë„ìš°ë¯¸
  aiHomeworkEnabled Boolean @default(false) // AI ìˆ™ì œ ê²€ì‚¬
  aiStudyEnabled    Boolean @default(false) // AI í•™ìŠµ ë„ìš°ë¯¸
  emailVerified DateTime?
  image         String?
  approved      Boolean   @default(false) // í•™ì›ì¥/ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”
  approvedBy    String?
  approvedAt    DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  academy       Academy?  @relation(fields: [academyId], references: [id], onDelete: SetNull)
  accounts      Account[]
  sessions      Session[]
  aiUsages      AIUsage[]
  pointHistory  PointHistory[]
  
  // í•™ìƒ ê´€ë ¨ ë°ì´í„°
  learningProgress  LearningProgress[]
  assignments       Assignment[]
  testScores        TestScore[]
  attendances       Attendance[]
  enrolledClasses   StudentClass[]  // ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…
  
  // ì„ ìƒë‹˜ì´ ìƒì„±í•œ ìë£Œ
  createdMaterials  LearningMaterial[] @relation("CreatedBy")
  createdAssignments Assignment[] @relation("AssignedBy")
  
  // AI ë´‡ ê´€ê³„
  createdAIBots     AIBot[]         // ê´€ë¦¬ìê°€ ìƒì„±í•œ AI ë´‡
  assignedBots      BotAssignment[] @relation("AssignedTo")
  grantedBots       BotAssignment[] @relation("GrantedBy")
  
  @@index([academyId])
  @@index([role])
  @@index([approved])
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// í•™ìŠµ ìë£Œ ê´€ë¦¬
model LearningMaterial {
  id            String      @id @default(cuid())
  academyId     String      // ì†Œì† í•™ì›
  title         String
  description   String?
  subject       String      // ê³¼ëª© (ìˆ˜í•™, ì˜ì–´, ê³¼í•™ ë“±)
  grade         String      // í•™ë…„
  category      String      // ì¹´í…Œê³ ë¦¬ (ê°•ì˜, êµì¬, ì—°ìŠµë¬¸ì œ ë“±)
  contentType   String      // ì½˜í…ì¸  íƒ€ì… (video, pdf, quiz, text)
  contentUrl    String?     // íŒŒì¼/ë™ì˜ìƒ URL
  content       String?     @db.Text // í…ìŠ¤íŠ¸ ì½˜í…ì¸ 
  duration      Int?        // ì˜ˆìƒ í•™ìŠµ ì‹œê°„ (ë¶„)
  difficulty    String      @default("MEDIUM") // EASY, MEDIUM, HARD
  tags          String?     // JSON array
  viewCount     Int         @default(0)
  isPublished   Boolean     @default(true)
  order         Int         @default(0) // ìˆœì„œ
  createdById   String
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  progress      LearningProgress[]
  assignments   Assignment[]
  
  @@index([academyId])
  @@index([subject, grade])
  @@index([createdById])
}

// í•™ìŠµ ì§„ë„ ê´€ë¦¬
model LearningProgress {
  id              String          @id @default(cuid())
  userId          String
  materialId      String
  status          String          @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED
  progress        Int             @default(0) // 0-100%
  timeSpent       Int             @default(0) // í•™ìŠµ ì‹œê°„ (ë¶„)
  lastAccessedAt  DateTime        @default(now())
  completedAt     DateTime?
  notes           String?         // í•™ìƒ ë©”ëª¨
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  material        LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  
  @@unique([userId, materialId])
  @@index([userId, status])
}

// ê³¼ì œ ê´€ë¦¬
model Assignment {
  id            String      @id @default(cuid())
  title         String
  description   String?
  materialId    String?     // ì—°ê²°ëœ í•™ìŠµ ìë£Œ
  userId        String      // ê³¼ì œë¥¼ ë°›ì€ í•™ìƒ
  assignedById  String      // ê³¼ì œë¥¼ ë¶€ì—¬í•œ ì„ ìƒë‹˜/í•™ì›ì¥
  subject       String
  dueDate       DateTime
  status        String      @default("PENDING") // PENDING, SUBMITTED, GRADED
  submittedAt   DateTime?
  submission    String?     // ì œì¶œ ë‚´ìš©
  score         Int?        // ì ìˆ˜
  feedback      String?     // í”¼ë“œë°±
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedBy    User        @relation("AssignedBy", fields: [assignedById], references: [id])
  material      LearningMaterial? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  
  @@index([userId, status])
  @@index([dueDate])
}

// ì‹œí—˜ ì ìˆ˜ ê´€ë¦¬
model TestScore {
  id            String      @id @default(cuid())
  userId        String
  subject       String
  testName      String
  testDate      DateTime
  score         Int
  maxScore      Int         @default(100)
  grade         String?     // ë“±ê¸‰
  rank          Int?        // ì„ì°¨
  totalStudents Int?        // ì‘ì‹œ ì¸ì›
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, testDate])
  @@index([subject])
}

// ì¶œì„ ê´€ë¦¬
model Attendance {
  id            String      @id @default(cuid())
  userId        String
  classId       String?     // ìˆ˜ì—… ID (ì„ íƒ)
  date          DateTime
  status        String      // PRESENT(ì¶œì„), ABSENT(ê²°ì„), LATE(ì§€ê°), EXCUSED(ì¡°í‡´)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  class         Class?      @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  @@unique([userId, classId, date])
  @@index([date])
  @@index([classId, date])
  @@index([userId, status])
}

// ê³µì§€ì‚¬í•­
model Notice {
  id            String      @id @default(cuid())
  academyId     String?     // nullì´ë©´ ì „ì²´ ê³µì§€
  title         String
  content       String      @db.Text
  author        String
  category      String      @default("GENERAL") // GENERAL, IMPORTANT, EVENT
  isPinned      Boolean     @default(false)
  viewCount     Int         @default(0)
  publishedAt   DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([academyId])
  @@index([publishedAt])
  @@index([category, isPinned])
}

// ë¬¸ì˜í•˜ê¸°
model Contact {
  id            String      @id @default(cuid())
  name          String
  email         String
  phone         String?
  subject       String
  message       String      @db.Text
  status        String      @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED
  response      String?     @db.Text
  respondedBy   String?     // ì‘ë‹µí•œ ê´€ë¦¬ì ID
  respondedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

// í¬ì¸íŠ¸ ì´ë ¥
model PointHistory {
  id            String      @id @default(cuid())
  userId        String
  amount        Int         // ì–‘ìˆ˜: ì§€ê¸‰, ìŒìˆ˜: íšŒìˆ˜
  balance       Int         // ê±°ë˜ í›„ ì”ì•¡
  type          String      // GRANT, DEDUCT, PURCHASE, REWARD
  reason        String?     // ì‚¬ìœ 
  adminId       String?     // ì²˜ë¦¬í•œ ê´€ë¦¬ì ID
  createdAt     DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
}

// ìˆ˜ì—… í´ë˜ìŠ¤ (ë°˜)
model Class {
  id            String      @id @default(cuid())
  academyId     String
  name          String      // ì˜ˆ: "ì¤‘ë“± 1í•™ë…„ Aë°˜", "ê³ ë“± ìˆ˜í•™ íŠ¹ê°•ë°˜"
  grade         String?     // í•™ë…„ (ì´ˆ1, ì¤‘2, ê³ 3 ë“±)
  description   String?
  teacherId     String?     // ë‹´ë‹¹ ì„ ìƒë‹˜
  capacity      Int         @default(20) // ì •ì›
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  students      StudentClass[]
  schedules     ClassSchedule[]
  attendances   Attendance[]
  
  @@index([academyId])
  @@index([teacherId])
}

// í•™ìƒ-ìˆ˜ì—… ì—°ê²° (ë‹¤ëŒ€ë‹¤)
model StudentClass {
  id            String      @id @default(cuid())
  studentId     String
  classId       String
  enrolledAt    DateTime    @default(now())
  status        String      @default("ACTIVE") // ACTIVE, COMPLETED, DROPPED
  
  student       User        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class         Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
}

// ìˆ˜ì—… ìŠ¤ì¼€ì¤„ (ì‹œê°„í‘œ)
model ClassSchedule {
  id            String      @id @default(cuid())
  classId       String
  subject       String      // ê³¼ëª© (ìˆ˜í•™, ì˜ì–´, ê³¼í•™ ë“±)
  dayOfWeek     Int         // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
  startTime     String      // "09:00"
  endTime       String      // "10:30"
  room          String?     // ê°•ì˜ì‹¤
  teacherId     String?     // ë‹´ë‹¹ ì„ ìƒë‹˜
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  class         Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  @@index([classId])
  @@index([dayOfWeek])
  @@index([teacherId])
}

// AI ë´‡ ì •ì˜ (ê´€ë¦¬ìê°€ ìƒì„±/ê´€ë¦¬)
model AIBot {
  id            String      @id @default(cuid())
  botId         String      @unique  // ê³ ìœ  ì‹ë³„ì (ì˜ˆ: study-helper, math-tutor)
  name          String                // í•œê¸€ ì´ë¦„ (ì˜ˆ: í•™ìŠµ ë„ìš°ë¯¸)
  nameEn        String                // ì˜ë¬¸ ì´ë¦„ (ì˜ˆ: Study Helper)
  description   String      @db.Text  // ë´‡ ì„¤ëª…
  icon          String      @default("ğŸ¤–") // ì´ëª¨ì§€ ì•„ì´ì½˜
  color         String      @default("blue") // ìƒ‰ìƒ í…Œë§ˆ
  bgGradient    String      @default("from-blue-50 to-cyan-50") // ë°°ê²½ ê·¸ë¼ë°ì´ì…˜
  systemPrompt  String      @db.Text  // AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì§€ì¹¨ì‚¬í•­)
  isActive      Boolean     @default(true)  // í™œì„±í™” ì—¬ë¶€
  createdById   String      // ìƒì„±ì
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  createdBy     User        @relation(fields: [createdById], references: [id])
  
  @@index([botId])
  @@index([isActive])
}

// AI ë´‡ í• ë‹¹ ê´€ë¦¬
model BotAssignment {
  id            String      @id @default(cuid())
  userId        String      // ë´‡ì„ í• ë‹¹ë°›ì€ ì‚¬ìš©ì (í•™ì›ì¥ ë˜ëŠ” í•™ìƒ)
  botId         String      // gems ID (study-helper, writing-coach, etc.)
  grantedById   String      // ë´‡ì„ í• ë‹¹í•´ì¤€ ì‚¬ìš©ì (ê´€ë¦¬ì ë˜ëŠ” í•™ì›ì¥)
  grantedByRole String      // SUPER_ADMIN or DIRECTOR
  isActive      Boolean     @default(true)
  expiresAt     DateTime?   // ë§Œë£Œì¼ (ì„ íƒ ì‚¬í•­)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation("AssignedTo", fields: [userId], references: [id], onDelete: Cascade)
  grantedBy     User        @relation("GrantedBy", fields: [grantedById], references: [id], onDelete: Cascade)
  
  @@unique([userId, botId])
  @@index([userId, isActive])
  @@index([grantedById])
  @@index([botId])
}
