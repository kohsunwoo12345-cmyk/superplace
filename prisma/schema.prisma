// Prisma Schema for Academy Learning Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// User Model - 학원장과 학생 모두 포함
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  phone         String?
  role          String    @default("STUDENT") // DIRECTOR(학원장), TEACHER(선생님), STUDENT(학생)
  grade         String?   // 학년 (학생용)
  class         String?   // 반 (학생용)
  studentId     String?   @unique // 학번 (학생용)
  parentPhone   String?   // 학부모 연락처 (학생용)
  emailVerified DateTime?
  image         String?
  approved      Boolean   @default(false) // 학원장 승인 필요
  approvedBy    String?
  approvedAt    DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts      Account[]
  sessions      Session[]
  
  // 학생 관련 데이터
  learningProgress  LearningProgress[]
  assignments       Assignment[]
  testScores        TestScore[]
  attendances       Attendance[]
  
  // 선생님이 생성한 자료
  createdMaterials  LearningMaterial[] @relation("CreatedBy")
  createdAssignments Assignment[] @relation("AssignedBy")
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 학습 자료 관리
model LearningMaterial {
  id            String      @id @default(cuid())
  title         String
  description   String?
  subject       String      // 과목 (수학, 영어, 과학 등)
  grade         String      // 학년
  category      String      // 카테고리 (강의, 교재, 연습문제 등)
  contentType   String      // 콘텐츠 타입 (video, pdf, quiz, text)
  contentUrl    String?     // 파일/동영상 URL
  content       String?     // 텍스트 콘텐츠
  duration      Int?        // 예상 학습 시간 (분)
  difficulty    String      @default("MEDIUM") // EASY, MEDIUM, HARD
  tags          String?     // JSON array
  viewCount     Int         @default(0)
  isPublished   Boolean     @default(true)
  order         Int         @default(0) // 순서
  createdById   String
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  progress      LearningProgress[]
  assignments   Assignment[]
  
  @@index([subject, grade])
  @@index([createdById])
}

// 학습 진도 관리
model LearningProgress {
  id              String          @id @default(cuid())
  userId          String
  materialId      String
  status          String          @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED
  progress        Int             @default(0) // 0-100%
  timeSpent       Int             @default(0) // 학습 시간 (분)
  lastAccessedAt  DateTime        @default(now())
  completedAt     DateTime?
  notes           String?         // 학생 메모
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  material        LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  
  @@unique([userId, materialId])
  @@index([userId, status])
}

// 과제 관리
model Assignment {
  id            String      @id @default(cuid())
  title         String
  description   String?
  materialId    String?     // 연결된 학습 자료
  userId        String      // 과제를 받은 학생
  assignedById  String      // 과제를 부여한 선생님/학원장
  subject       String
  dueDate       DateTime
  status        String      @default("PENDING") // PENDING, SUBMITTED, GRADED
  submittedAt   DateTime?
  submission    String?     // 제출 내용
  score         Int?        // 점수
  feedback      String?     // 피드백
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedBy    User        @relation("AssignedBy", fields: [assignedById], references: [id])
  material      LearningMaterial? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  
  @@index([userId, status])
  @@index([dueDate])
}

// 시험 점수 관리
model TestScore {
  id            String      @id @default(cuid())
  userId        String
  subject       String
  testName      String
  testDate      DateTime
  score         Int
  maxScore      Int         @default(100)
  grade         String?     // 등급
  rank          Int?        // 석차
  totalStudents Int?        // 응시 인원
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, testDate])
  @@index([subject])
}

// 출석 관리
model Attendance {
  id            String      @id @default(cuid())
  userId        String
  date          DateTime
  status        String      // PRESENT(출석), ABSENT(결석), LATE(지각), EXCUSED(조퇴)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([date])
  @@index([userId, status])
}

// 공지사항
model Notice {
  id            String      @id @default(cuid())
  title         String
  content       String
  author        String
  category      String      @default("GENERAL") // GENERAL, IMPORTANT, EVENT
  isPinned      Boolean     @default(false)
  viewCount     Int         @default(0)
  publishedAt   DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([publishedAt])
  @@index([category, isPinned])
}
