// Prisma Schema for Academy Learning Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// í•™ì› ëª¨ë¸
model Academy {
  id              String    @id @default(cuid())
  name            String    // í•™ì› ì´ë¦„
  code            String    @unique // í•™ì› ì½”ë“œ (ê°€ì…ìš©)
  description     String?
  address         String?
  phone           String?
  email           String?
  logoUrl         String?
  naverPlaceUrl   String?   // ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ URL
  naverBlogUrl    String?   // ë„¤ì´ë²„ ë¸”ë¡œê·¸ URL
  subscriptionPlan String   @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  maxStudents     Int       @default(10)     // ìš”ê¸ˆì œë³„ í•™ìƒ ìˆ˜ ì œí•œ
  maxTeachers     Int       @default(2)      // ìš”ê¸ˆì œë³„ ì„ ìƒë‹˜ ìˆ˜ ì œí•œ
  aiUsageLimit    Int       @default(100)    // ì›”ë³„ AI ì‚¬ìš© íšŸìˆ˜ ì œí•œ
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  users           User[]
  subscriptions   Subscription[]
  aiUsages        AIUsage[]
  payments        Payment[]
  homeworkSubmissions HomeworkSubmission[] // í•™ì› ë‚´ ìˆ™ì œ ì œì¶œ
  
  @@index([subscriptionPlan])
  @@index([code])
}

// êµ¬ë…/ìš”ê¸ˆì œ ì´ë ¥
model Subscription {
  id              String    @id @default(cuid())
  academyId       String
  plan            String    // FREE, BASIC, PRO, ENTERPRISE
  status          String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  startDate       DateTime  @default(now())
  endDate         DateTime?
  price           Decimal   @default(0)
  paymentMethod   String?
  transactionId   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  
  @@index([academyId, status])
  @@index([endDate])
}

// AI ì‚¬ìš©ëŸ‰ ì¶”ì 
model AIUsage {
  id              String    @id @default(cuid())
  academyId       String
  userId          String
  model           String    @default("gemini-pro") // gemini-pro, gemini-pro-vision
  promptTokens    Int       @default(0)
  completionTokens Int      @default(0)
  totalTokens     Int       @default(0)
  request         String    @db.Text // ìš”ì²­ ë‚´ìš©
  response        String?   @db.Text // ì‘ë‹µ ë‚´ìš©
  createdAt       DateTime  @default(now())
  
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([academyId, createdAt])
  @@index([userId, createdAt])
}

// User Model - ì‹œìŠ¤í…œ ê´€ë¦¬ì, í•™ì›ì¥, ì„ ìƒë‹˜, í•™ìƒ
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  phone         String?
  role          String    @default("STUDENT") // SUPER_ADMIN, DIRECTOR, TEACHER, STUDENT
  academyId     String?   // ì†Œì† í•™ì› (SUPER_ADMINì€ null)
  school        String?   // í•™êµëª… (í•™ìƒìš©)
  grade         String?   // í•™ë…„ (í•™ìƒìš©: ì´ˆ1~ê³ 3)
  class         String?   // ë°˜ (í•™ìƒìš©) - deprecated, StudentClass ì‚¬ìš©
  studentId     String?   @unique // í•™ë²ˆ (í•™ìƒìš©)
  studentCode   String?   @unique // í•™ìƒ 5ìë¦¬ ì½”ë“œ (ë¡œê·¸ì¸ìš©)
  parentPhone   String?   // í•™ë¶€ëª¨ ì—°ë½ì²˜ (í•™ìƒìš©)
  points        Int       @default(0) // í¬ì¸íŠ¸
  aiChatEnabled     Boolean @default(false) // AI ì±„íŒ… ë„ìš°ë¯¸
  aiHomeworkEnabled Boolean @default(false) // AI ìˆ™ì œ ê²€ì‚¬
  aiStudyEnabled    Boolean @default(false) // AI í•™ìŠµ ë„ìš°ë¯¸
  emailVerified DateTime?
  image         String?
  approved      Boolean   @default(false) // í•™ì›ì¥/ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”
  approvedBy    String?
  approvedAt    DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  academy       Academy?  @relation(fields: [academyId], references: [id], onDelete: SetNull)
  accounts      Account[]
  sessions      Session[]
  aiUsages      AIUsage[]
  pointHistory  PointHistory[]
  
  // í•™ìƒ ê´€ë ¨ ë°ì´í„°
  learningProgress  LearningProgress[]
  assignments       Assignment[]
  homeworkSubmissions HomeworkSubmission[] // ìˆ™ì œ ì œì¶œ ë‚´ì—­
  testScores        TestScore[]
  attendances       Attendance[]
  enrolledClasses   StudentClass[]  // ìˆ˜ê°• ì¤‘ì¸ ìˆ˜ì—…
  
  // ì„ ìƒë‹˜ì´ ìƒì„±í•œ ìë£Œ
  createdMaterials  LearningMaterial[] @relation("CreatedBy")
  createdAssignments Assignment[] @relation("AssignedBy")
  
  // AI ë´‡ ê´€ê³„
  assignedBots      BotAssignment[] @relation("AssignedTo")
  grantedBots       BotAssignment[] @relation("GrantedBy")
  conversations     BotConversation[] // ë´‡ê³¼ì˜ ëŒ€í™” ê¸°ë¡
  conversationAnalyses ConversationAnalysis[] // ëŒ€í™” ë¶„ì„ ê²°ê³¼
  originalSwitches  AccountSwitch[] @relation("OriginalUser") // ì›ë˜ ê³„ì •ìœ¼ë¡œì„œì˜ ì „í™˜ ê¸°ë¡
  targetSwitches    AccountSwitch[] @relation("TargetUser") // ì „í™˜ ëŒ€ìƒ ê³„ì •ìœ¼ë¡œì„œì˜ ê¸°ë¡
  accessLogs        AccessLog[]     // ì ‘ì† ë¡œê·¸
  activityLogs      ActivityLog[]   // í™œë™ ë¡œê·¸
  payments          Payment[]       // ê²°ì œ ë‚´ì—­
  createdBots       AIBot[]  @relation("CreatedBots")       // ìƒì„±í•œ AI ë´‡
  createdFolders    BotFolder[]     // ìƒì„±í•œ í´ë”
  
  @@index([academyId])
  @@index([role])
  @@index([approved])
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// í•™ìŠµ ìë£Œ ê´€ë¦¬
model LearningMaterial {
  id            String      @id @default(cuid())
  academyId     String      // ì†Œì† í•™ì›
  title         String
  description   String?
  subject       String      // ê³¼ëª© (ìˆ˜í•™, ì˜ì–´, ê³¼í•™ ë“±)
  grade         String      // í•™ë…„
  category      String      // ì¹´í…Œê³ ë¦¬ (ê°•ì˜, êµì¬, ì—°ìŠµë¬¸ì œ ë“±)
  contentType   String      // ì½˜í…ì¸  íƒ€ì… (video, pdf, quiz, text)
  contentUrl    String?     // íŒŒì¼/ë™ì˜ìƒ URL
  content       String?     @db.Text // í…ìŠ¤íŠ¸ ì½˜í…ì¸ 
  duration      Int?        // ì˜ˆìƒ í•™ìŠµ ì‹œê°„ (ë¶„)
  difficulty    String      @default("MEDIUM") // EASY, MEDIUM, HARD
  tags          String?     // JSON array
  viewCount     Int         @default(0)
  isPublished   Boolean     @default(true)
  order         Int         @default(0) // ìˆœì„œ
  createdById   String
  createdBy     User        @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  progress      LearningProgress[]
  assignments   Assignment[]
  
  @@index([academyId])
  @@index([subject, grade])
  @@index([createdById])
}

// í•™ìŠµ ì§„ë„ ê´€ë¦¬
model LearningProgress {
  id              String          @id @default(cuid())
  userId          String
  materialId      String
  status          String          @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED
  progress        Int             @default(0) // 0-100%
  timeSpent       Int             @default(0) // í•™ìŠµ ì‹œê°„ (ë¶„)
  lastAccessedAt  DateTime        @default(now())
  completedAt     DateTime?
  notes           String?         // í•™ìƒ ë©”ëª¨
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  material        LearningMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)
  
  @@unique([userId, materialId])
  @@index([userId, status])
}

// ê³¼ì œ ê´€ë¦¬
model Assignment {
  id            String      @id @default(cuid())
  title         String
  description   String?
  materialId    String?     // ì—°ê²°ëœ í•™ìŠµ ìë£Œ
  userId        String      // ê³¼ì œë¥¼ ë°›ì€ í•™ìƒ
  assignedById  String      // ê³¼ì œë¥¼ ë¶€ì—¬í•œ ì„ ìƒë‹˜/í•™ì›ì¥
  subject       String
  dueDate       DateTime
  status        String      @default("PENDING") // PENDING, SUBMITTED, GRADED
  submittedAt   DateTime?
  submission    String?     // ì œì¶œ ë‚´ìš©
  score         Int?        // ì ìˆ˜
  feedback      String?     // í”¼ë“œë°±
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignedBy    User        @relation("AssignedBy", fields: [assignedById], references: [id])
  material      LearningMaterial? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  
  @@index([userId, status])
  @@index([dueDate])
}

// ìˆ™ì œ ì œì¶œ (Homework Submission)
model HomeworkSubmission {
  id            String      @id @default(cuid())
  userId        String      // ì œì¶œí•œ í•™ìƒ
  academyId     String      // ì†Œì† í•™ì›
  imageUrl      String      // ìˆ™ì œ ì‚¬ì§„ URL
  aiAnalysis    String?     @db.Text // AI ë¶„ì„ ê²°ê³¼
  aiFeedback    String?     @db.Text // AI í”¼ë“œë°±
  completeness  Int?        // ì™„ì„±ë„ ì ìˆ˜ (0-100)
  accuracy      Int?        // ì •í™•ë„ ì ìˆ˜ (0-100)
  effort        Int?        // ë…¸ë ¥ë„ ì ìˆ˜ (0-100)
  overallScore  Int?        // ì¢…í•© ì ìˆ˜ (0-100)
  attendanceMarked Boolean  @default(false) // ì¶œì„ ì¸ì • ì—¬ë¶€
  submittedAt   DateTime    @default(now())
  analyzedAt    DateTime?   // AI ë¶„ì„ ì™„ë£Œ ì‹œê°„
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  academy       Academy     @relation(fields: [academyId], references: [id], onDelete: Cascade)
  
  @@index([userId, submittedAt])
  @@index([academyId, submittedAt])
  @@index([attendanceMarked])
}

// ì‹œí—˜ ì ìˆ˜ ê´€ë¦¬
model TestScore {
  id            String      @id @default(cuid())
  userId        String
  subject       String
  testName      String
  testDate      DateTime
  score         Int
  maxScore      Int         @default(100)
  grade         String?     // ë“±ê¸‰
  rank          Int?        // ì„ì°¨
  totalStudents Int?        // ì‘ì‹œ ì¸ì›
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, testDate])
  @@index([subject])
}

// ì¶œì„ ê´€ë¦¬
model Attendance {
  id            String      @id @default(cuid())
  userId        String
  classId       String?     // ìˆ˜ì—… ID (ì„ íƒ)
  date          DateTime
  status        String      // PRESENT(ì¶œì„), ABSENT(ê²°ì„), LATE(ì§€ê°), EXCUSED(ì¡°í‡´)
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  class         Class?      @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  @@unique([userId, classId, date])
  @@index([date])
  @@index([classId, date])
  @@index([userId, status])
}

// ê³µì§€ì‚¬í•­
model Notice {
  id            String      @id @default(cuid())
  academyId     String?     // nullì´ë©´ ì „ì²´ ê³µì§€
  title         String
  content       String      @db.Text
  author        String
  category      String      @default("GENERAL") // GENERAL, IMPORTANT, EVENT
  isPinned      Boolean     @default(false)
  viewCount     Int         @default(0)
  publishedAt   DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([academyId])
  @@index([publishedAt])
  @@index([category, isPinned])
}

// ë¬¸ì˜í•˜ê¸°
model Contact {
  id            String      @id @default(cuid())
  name          String
  email         String
  phone         String?
  subject       String
  message       String      @db.Text
  status        String      @default("PENDING") // PENDING, IN_PROGRESS, RESOLVED
  response      String?     @db.Text
  respondedBy   String?     // ì‘ë‹µí•œ ê´€ë¦¬ì ID
  respondedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

// í¬ì¸íŠ¸ ì´ë ¥
model PointHistory {
  id            String      @id @default(cuid())
  userId        String
  amount        Int         // ì–‘ìˆ˜: ì§€ê¸‰, ìŒìˆ˜: íšŒìˆ˜
  balance       Int         // ê±°ë˜ í›„ ì”ì•¡
  type          String      // GRANT, DEDUCT, PURCHASE, REWARD
  reason        String?     // ì‚¬ìœ 
  adminId       String?     // ì²˜ë¦¬í•œ ê´€ë¦¬ì ID
  createdAt     DateTime    @default(now())
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
}

// ìˆ˜ì—… í´ë˜ìŠ¤ (ë°˜)
model Class {
  id            String      @id @default(cuid())
  academyId     String
  name          String      // ì˜ˆ: "ì¤‘ë“± 1í•™ë…„ Aë°˜", "ê³ ë“± ìˆ˜í•™ íŠ¹ê°•ë°˜"
  grade         String?     // í•™ë…„ (ì´ˆ1, ì¤‘2, ê³ 3 ë“±)
  description   String?
  teacherId     String?     // ë‹´ë‹¹ ì„ ìƒë‹˜
  capacity      Int         @default(20) // ì •ì›
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  students      StudentClass[]
  schedules     ClassSchedule[]
  attendances   Attendance[]
  
  @@index([academyId])
  @@index([teacherId])
}

// í•™ìƒ-ìˆ˜ì—… ì—°ê²° (ë‹¤ëŒ€ë‹¤)
model StudentClass {
  id            String      @id @default(cuid())
  studentId     String
  classId       String
  enrolledAt    DateTime    @default(now())
  status        String      @default("ACTIVE") // ACTIVE, COMPLETED, DROPPED
  
  student       User        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class         Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
}

// ìˆ˜ì—… ìŠ¤ì¼€ì¤„ (ì‹œê°„í‘œ)
model ClassSchedule {
  id            String      @id @default(cuid())
  classId       String
  subject       String      // ê³¼ëª© (ìˆ˜í•™, ì˜ì–´, ê³¼í•™ ë“±)
  dayOfWeek     Int         // 0: ì¼ìš”ì¼, 1: ì›”ìš”ì¼, ..., 6: í† ìš”ì¼
  startTime     String      // "09:00"
  endTime       String      // "10:30"
  room          String?     // ê°•ì˜ì‹¤
  teacherId     String?     // ë‹´ë‹¹ ì„ ìƒë‹˜
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  class         Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  @@index([classId])
  @@index([dayOfWeek])
  @@index([teacherId])
}

// AI ë´‡ ì •ì˜ (ê´€ë¦¬ìê°€ ìƒì„±/ê´€ë¦¬)
model AIBot {
  id            String      @id @default(cuid())
  botId         String      @unique  // ê³ ìœ  ì‹ë³„ì (ì˜ˆ: study-helper, math-tutor)
  name          String                // í•œê¸€ ì´ë¦„ (ì˜ˆ: í•™ìŠµ ë„ìš°ë¯¸)
  nameEn        String                // ì˜ë¬¸ ì´ë¦„ (ì˜ˆ: Study Helper)
  description   String      @db.Text  // ë´‡ ì„¤ëª…
  icon          String      @default("ğŸ¤–") // ì´ëª¨ì§€ ì•„ì´ì½˜
  color         String      @default("blue") // ìƒ‰ìƒ í…Œë§ˆ
  bgGradient    String      @default("from-blue-50 to-cyan-50") // ë°°ê²½ ê·¸ë¼ë°ì´ì…˜
  systemPrompt  String      @db.Text  // AI ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì§€ì¹¨ì‚¬í•­)
  referenceFiles String[]              // ì°¸ê³  íŒŒì¼ URL ë°°ì—´ (PDF, DOCX, etc.)
  starterMessages String[]             // ì±„íŒ… ì‹œì‘ ì‹œ ì¶”ì²œ ì§ˆë¬¸ (ìµœëŒ€ 4ê°œ)
  
  // ë©€í‹°ëª¨ë‹¬ ê¸°ëŠ¥ ì„¤ì •
  enableImageInput   Boolean  @default(false) // ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ ì²¨ë¶€ ê°€ëŠ¥ ì—¬ë¶€
  enableVoiceOutput  Boolean  @default(false) // ë´‡ ì‘ë‹µì„ ìŒì„±ìœ¼ë¡œ ì¶œë ¥ ì—¬ë¶€
  enableVoiceInput   Boolean  @default(false) // ì‚¬ìš©ìê°€ ìŒì„± ë…¹ìŒ ì…ë ¥ ê°€ëŠ¥ ì—¬ë¶€
  
  folderId      String?     // í´ë” ID (ì„ íƒ)
  isActive      Boolean     @default(true)  // í™œì„±í™” ì—¬ë¶€
  createdById   String      // ìƒì„±ì
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  createdBy     User        @relation("CreatedBots", fields: [createdById], references: [id])
  folder        BotFolder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)
  
  @@index([botId])
  @@index([isActive])
  @@index([folderId])
}

// AI ë´‡ í• ë‹¹ ê´€ë¦¬
model BotAssignment {
  id            String      @id @default(cuid())
  userId        String      // ë´‡ì„ í• ë‹¹ë°›ì€ ì‚¬ìš©ì (í•™ì›ì¥, ì„ ìƒë‹˜, ë˜ëŠ” í•™ìƒ)
  botId         String      // gems ID (study-helper, writing-coach, etc.)
  grantedById   String      // ë´‡ì„ í• ë‹¹í•´ì¤€ ì‚¬ìš©ì (ê´€ë¦¬ì, í•™ì›ì¥, ë˜ëŠ” ì„ ìƒë‹˜)
  grantedByRole String      // SUPER_ADMIN, DIRECTOR, or TEACHER
  isActive      Boolean     @default(true)
  expiresAt     DateTime?   // ë§Œë£Œì¼ (ì„ íƒ ì‚¬í•­)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation("AssignedTo", fields: [userId], references: [id], onDelete: Cascade)
  grantedBy     User        @relation("GrantedBy", fields: [grantedById], references: [id], onDelete: Cascade)
  
  @@unique([userId, botId])
  @@index([userId, isActive])
  @@index([grantedById])
  @@index([botId])
}

// AI ë´‡ ëŒ€í™” ê¸°ë¡
model BotConversation {
  id            String      @id @default(cuid())
  userId        String      // ëŒ€í™”í•œ ì‚¬ìš©ì
  botId         String      // ëŒ€í™”í•œ ë´‡ ID
  messages      Json        // ëŒ€í™” ë©”ì‹œì§€ ë°°ì—´ [{role, content, timestamp}]
  messageCount  Int         @default(0) // ì´ ë©”ì‹œì§€ ìˆ˜
  userMessageCount Int      @default(0) // ì‚¬ìš©ì ë©”ì‹œì§€ ìˆ˜
  botMessageCount Int       @default(0) // ë´‡ ë©”ì‹œì§€ ìˆ˜
  sessionDuration Int?      // ëŒ€í™” ì‹œê°„ (ì´ˆ)
  lastMessageAt DateTime    // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis      ConversationAnalysis? // AI ë¶„ì„ ê²°ê³¼
  
  @@index([userId, botId])
  @@index([userId, lastMessageAt])
  @@index([botId])
}

// AI ëŒ€í™” ë¶„ì„ ê²°ê³¼
model ConversationAnalysis {
  id                String      @id @default(cuid())
  conversationId    String      @unique
  userId            String      // ë¶„ì„ ëŒ€ìƒ í•™ìƒ
  botId             String      // ì‚¬ìš©í•œ ë´‡
  
  // ì°¸ì—¬ë„ ì§€í‘œ
  engagementScore   Float       @default(0) // ì°¸ì—¬ë„ ì ìˆ˜ (0-100)
  responseQuality   Float       @default(0) // ì‘ë‹µ í’ˆì§ˆ (0-100)
  questionDepth     Float       @default(0) // ì§ˆë¬¸ ê¹Šì´ (0-100)
  consistency       Float       @default(0) // ì¼ê´€ì„± (0-100)
  
  // í–‰ë™ ë¶„ì„
  avgResponseTime   Int?        // í‰ê·  ì‘ë‹µ ì‹œê°„ (ì´ˆ)
  avgMessageLength  Int?        // í‰ê·  ë©”ì‹œì§€ ê¸¸ì´
  topicDiversity    Float       @default(0) // ì£¼ì œ ë‹¤ì–‘ì„±
  
  // AI ë¶„ì„ ê²°ê³¼
  strengths         String[]    // ê°•ì 
  weaknesses        String[]    // ì•½ì 
  recommendations   String[]    // ì¶”ì²œ ì‚¬í•­
  summary           String      @db.Text // ì¢…í•© ë¶„ì„
  
  // ë©”íƒ€ ì •ë³´
  analyzedAt        DateTime    @default(now())
  analyzedBy        String      @default("AI") // AI or USER_ID
  
  conversation      BotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, analyzedAt])
  @@index([botId])
}


// ê³„ì • ì „í™˜ ê¸°ë¡ (í•™ì›ì¥ â†’ í•™ìƒ/ì„ ìƒë‹˜, ì„ ìƒë‹˜ â†’ í•™ìƒ)
model AccountSwitch {
  id                String    @id @default(cuid())
  originalUserId    String    // ì›ë˜ ê³„ì • (í•™ì›ì¥ ë˜ëŠ” ì„ ìƒë‹˜)
  targetUserId      String    // ì „í™˜í•  ê³„ì • (í•™ìƒ ë˜ëŠ” ì„ ìƒë‹˜)
  originalRole      String    // ì›ë˜ ì—­í•  (DIRECTOR, TEACHER)
  targetRole        String    // ì „í™˜í•  ì—­í•  (STUDENT, TEACHER)
  academyId         String    // í•™ì› ID (ê¶Œí•œ ì²´í¬ìš©)
  sessionToken      String    @unique // ì „í™˜ ì„¸ì…˜ í† í°
  expiresAt         DateTime  // ë§Œë£Œ ì‹œê°„
  isActive          Boolean   @default(true)
  switchedAt        DateTime  @default(now())
  switchBackAt      DateTime? // ì›ë˜ ê³„ì •ìœ¼ë¡œ ë³µê·€í•œ ì‹œê°„
  
  originalUser      User      @relation("OriginalUser", fields: [originalUserId], references: [id], onDelete: Cascade)
  targetUser        User      @relation("TargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)
  
  @@index([originalUserId, isActive])
  @@index([targetUserId])
  @@index([sessionToken])
  @@index([expiresAt])
}

// ì ‘ì† ë¡œê·¸ (íšŒì›/ë¹„íšŒì› ì ‘ì† ì¶”ì )
model AccessLog {
  id            String    @id @default(cuid())
  userId        String?   // íšŒì› ID (ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ)
  sessionId     String    // ì„¸ì…˜ ID
  ipAddress     String    // IP ì£¼ì†Œ
  userAgent     String    @db.Text // User Agent
  browser       String?   // ë¸Œë¼ìš°ì €
  os            String?   // ìš´ì˜ì²´ì œ
  device        String?   // ë””ë°”ì´ìŠ¤ (mobile, tablet, desktop)
  
  // ì ‘ì† ì •ë³´
  path          String    @db.Text // ì ‘ì† ê²½ë¡œ
  method        String    // HTTP ë©”ì„œë“œ (GET, POST, etc.)
  statusCode    Int?      // HTTP ìƒíƒœ ì½”ë“œ
  
  // ì§€ì—­ ì •ë³´ (ì„ íƒ)
  country       String?   // êµ­ê°€
  city          String?   // ë„ì‹œ
  
  // ì‹œê°„ ì •ë³´
  accessedAt    DateTime  @default(now()) // ì ‘ì† ì‹œê°„
  duration      Int?      // ì²´ë¥˜ ì‹œê°„ (ì´ˆ)
  
  // í™œë™ ì •ë³´
  activityType  String?   // í™œë™ ìœ í˜• (login, logout, view_page, api_call, etc.)
  activityData  Json?     // í™œë™ ìƒì„¸ ë°ì´í„°
  
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId, accessedAt])
  @@index([sessionId])
  @@index([accessedAt])
  @@index([activityType])
}

// ì‚¬ìš©ì í™œë™ ë¡œê·¸ (ìƒì„¸ í™œë™ ì¶”ì )
model ActivityLog {
  id            String    @id @default(cuid())
  userId        String    // ì‚¬ìš©ì ID
  sessionId     String    // ì„¸ì…˜ ID
  
  // í™œë™ ì •ë³´
  action        String    // í™œë™ (create_student, view_report, send_message, etc.)
  resource      String?   // ëŒ€ìƒ ë¦¬ì†ŒìŠ¤ (student, report, message, etc.)
  resourceId    String?   // ë¦¬ì†ŒìŠ¤ ID
  description   String?   @db.Text // í™œë™ ì„¤ëª…
  metadata      Json?     // ì¶”ê°€ ë©”íƒ€ë°ì´í„°
  
  // IP ë° ê¸°ê¸° ì •ë³´
  ipAddress     String
  userAgent     String    @db.Text
  
  // ì‹œê°„ ì •ë³´
  createdAt     DateTime  @default(now())
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([action])
  @@index([sessionId])
  @@index([resource, resourceId])
}

// ì œí’ˆ/ìƒí’ˆ (ìš”ê¸ˆì œ)
model Product {
  id              String    @id @default(cuid())
  name            String    // ìƒí’ˆëª… (ì˜ˆ: "BASIC í”Œëœ", "PRO í”Œëœ")
  description     String?   @db.Text // ìƒí’ˆ ì„¤ëª…
  plan            String    // FREE, BASIC, PRO, ENTERPRISE
  price           Decimal   // ê°€ê²©
  currency        String    @default("KRW") // í†µí™” (KRW, USD, etc.)
  billingCycle    String    @default("MONTHLY") // MONTHLY, YEARLY, ONE_TIME
  features        Json?     // ì œê³µ ê¸°ëŠ¥ ëª©ë¡
  maxStudents     Int       @default(10)
  maxTeachers     Int       @default(2)
  aiUsageLimit    Int       @default(100)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  payments        Payment[]
  
  @@index([plan])
  @@index([isActive])
}

// ê²°ì œ (Payment)
model Payment {
  id              String    @id @default(cuid())
  
  // ê²°ì œ ì£¼ì²´
  academyId       String    // ê²°ì œí•œ í•™ì›
  userId          String    // ê²°ì œí•œ ì‚¬ìš©ì (í•™ì›ì¥)
  
  // ìƒí’ˆ ì •ë³´
  productId       String    // êµ¬ë§¤í•œ ìƒí’ˆ
  productName     String    // ìƒí’ˆëª… (ìŠ¤ëƒ…ìƒ·)
  plan            String    // ìš”ê¸ˆì œ (ìŠ¤ëƒ…ìƒ·)
  
  // ê²°ì œ ê¸ˆì•¡
  amount          Decimal   // ê²°ì œ ê¸ˆì•¡
  currency        String    @default("KRW")
  
  // ê²°ì œ ìƒíƒœ
  status          String    @default("PENDING") // PENDING, COMPLETED, FAILED, CANCELLED, REFUNDED
  
  // ê²°ì œ ìˆ˜ë‹¨
  paymentMethod   String?   // CARD, BANK_TRANSFER, VIRTUAL_ACCOUNT, KAKAO_PAY, NAVER_PAY
  paymentProvider String?   // ê²°ì œ ëŒ€í–‰ì‚¬ (TOSS, PORTONE, STRIPE, etc.)
  
  // ê²°ì œ ëŒ€í–‰ì‚¬ ì •ë³´
  transactionId   String?   @unique // ê±°ë˜ ID
  providerOrderId String?   // ê²°ì œ ëŒ€í–‰ì‚¬ ì£¼ë¬¸ ID
  receiptUrl      String?   // ì˜ìˆ˜ì¦ URL
  
  // ê²°ì œ ì‹œê°„
  paidAt          DateTime? // ê²°ì œ ì™„ë£Œ ì‹œê°„
  cancelledAt     DateTime? // ì·¨ì†Œ ì‹œê°„
  refundedAt      DateTime? // í™˜ë¶ˆ ì‹œê°„
  
  // êµ¬ë… ê¸°ê°„ (êµ¬ë…í˜• ìƒí’ˆì˜ ê²½ìš°)
  subscriptionStartDate DateTime? // êµ¬ë… ì‹œì‘ì¼
  subscriptionEndDate   DateTime? // êµ¬ë… ì¢…ë£Œì¼
  
  // ë©”íƒ€ë°ì´í„°
  metadata        Json?     // ì¶”ê°€ ì •ë³´
  failReason      String?   // ì‹¤íŒ¨ ì‚¬ìœ 
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  academy         Academy   @relation(fields: [academyId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  product         Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  @@index([academyId, status])
  @@index([userId, paidAt])
  @@index([status, paidAt])
  @@index([productId])
  @@index([transactionId])
  @@index([paidAt])
}

// AI ë´‡ í´ë”
model BotFolder {
  id          String    @id @default(cuid())
  name        String    // í´ë”ëª…
  description String?   @db.Text
  color       String?   @default("#3B82F6") // í´ë” ìƒ‰ìƒ
  icon        String?   @default("Folder") // í´ë” ì•„ì´ì½˜
  order       Int       @default(0) // ì •ë ¬ ìˆœì„œ
  createdBy   String    // ìƒì„±ì (SUPER_ADMIN)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  creator     User      @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  bots        AIBot[]
  
  @@index([createdBy])
  @@index([order])
}
